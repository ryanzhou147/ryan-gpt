<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RyanGPT Chat</title>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <div id="app"></div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
    const { createApp, ref, reactive, onMounted, watch } = Vue;

    const App = {
      template: `
      <div class="app">
        <header class="topbar">
          <h1>RyanGPT</h1>
          <div class="controls">
            <label class="switch-label">Model
              <select v-model="selected_model">
                <option v-for="m in models" :key="m.id" :value="m.checkpoint">{{ m.label }}</option>
              </select>
            </label>
            <label class="switch-label">Temp
              <input v-model.number="temperature" @blur="onTempBlur" type="number" min="0.01" max="0.99" style="width:50px" />
            </label>
            <label class="switch-label">Min Tokens
              <input v-model.number="min_tokens" @blur="onMinTokensBlur" type="number" min="10" max="140" style="width:50px" />
            </label>
          </div>
        </header>

        <main class="chat-container">
          <div class="messages">
            <div v-for="(m, idx) in messages" :key="idx" :class="['msg', m.role==='user' ? 'user' : 'bot']">
              <div v-if="m.role === 'bot'" class="meta">Assistant</div>
              <div class="body">{{ m.text }}</div>
            </div>
          </div>
        </main>

        <footer class="composer">
            <textarea id="prompt" v-model="prompt" placeholder="Send a message..." rows="2" style="width:800px"></textarea>
          <div class="composer-controls">
            <button @click="send" id="send" aria-label="Send">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </footer>
      </div>
      `,
      setup(){
        const models = ref([]);
        const selected_model = ref('');
        const prompt = ref('');
        const messages = reactive([]);
        const min_tokens = ref(10);
        const temperature = ref(0.5);

        // Watch for model changes and update min_tokens default
        watch(selected_model, (newVal) => {
          if (newVal.toLowerCase().includes('pretrain') && min_tokens.value < 10) {
            min_tokens.value = 10;
          } else if (newVal.toLowerCase().includes('finetune')) {
            min_tokens.value = 5;
          }
        });

        function onTempBlur() {
          if (temperature.value < 0.01) temperature.value = 0.01;
          if (temperature.value > 0.99) temperature.value = 0.99;
          temperature.value = Math.round(temperature.value * 100) / 100;
        }
        function onMinTokensBlur() {
          const isFinetune = selected_model.value.toLowerCase().includes('finetune');
          const minBound = isFinetune ? 5 : 10;
          const maxBound = 50;
          
          if (min_tokens.value < minBound) min_tokens.value = minBound;
          if (min_tokens.value > maxBound) min_tokens.value = maxBound;
          min_tokens.value = Math.round(min_tokens.value);
        }

        function append(role, text){
          messages.push({role, text});
          setTimeout(()=>{
            const el = document.querySelector('.chat-container');
            if(el) el.scrollTop = el.scrollHeight;
          }, 50);
        }

        async function send(){
          const text = prompt.value.trim();
          if(!text) return;
          append('user', text);
          prompt.value = '';
          append('bot', '...');

          try{
            const res = await fetch('/api/chat', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                model: selected_model.value,
                prompt: text,
                min_tokens: min_tokens.value,
                temperature: temperature.value,
              })
            });
            const data = await res.json();
            if(data.error){
              messages[messages.length-1].text = 'Error: ' + data.error;
            } else {
              messages[messages.length-1].text = data.reply;
            }
          } catch(err){
            messages[messages.length-1].text = 'Error: ' + err.message;
          }
        }

        onMounted(async ()=>{
          try{
            const r = await fetch('/api/models');
            const j = await r.json();
            if(j.models && j.models.length){
              // populate dropdown from API models list
                models.value = j.models;
                if (models.value.length) selected_model.value = models.value[0].checkpoint || '';
            }
          }catch(e){
            console.warn('Could not fetch models', e);
          }

          document.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter' && !e.shiftKey){
              const active = document.activeElement;
              if(active && active.tagName === 'TEXTAREA'){
                e.preventDefault();
                send();
              }
            }
          });
        });

      return { models, selected_model, prompt, messages, min_tokens, temperature, send, onTempBlur, onMinTokensBlur };      }
    };

    createApp(App).mount('#app');
    </script>
  </body>
</html>
